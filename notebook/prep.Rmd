---
title: "R Notebook"
output: html_notebook
---

Install and open the following packages/datasets.
```{r message=FALSE}
library(tidyverse)
library(stringr)
library(lubridate)
library(mmir)
library(bibi2.0)
data("hier.fwmi")
data("attributes.fwmi")
```
Import the data from the Access database.

```{r}

# USE THIS CODE IF YOU HAVE WINDOWS 64-BIT

library(odbc)
library(DBI)

channel <- dbConnect(odbc(), "CBIBI_2017")

tab.vec <- c("TAB_EVENT", "TAB_STATIONS", "TAB_PROJECT",
             "TAB_WQ_DATA", "TAB_PARAMETER_WQ", "TAB_HABITAT_ASSESSMENT",
             "TAB_HABITAT_PARAMETERS", "TAB_TAXONOMIC_COUNT",
             "TAB_HUC_12", "TAB_PROGRAM")

library(magrittr) 
tab.list <- purrr::map(tab.vec, function(tab.i) {
  dbReadTable(channel, tab.i, stringsAsFactors = FALSE) %>% 
    clean_data_frame()
}) %>% 
  set_names(tolower(tab.vec))

dbDisconnect(channel)

###########################################################################################

# USE THIS CODE IF YOU HAVE WINDOWS 32-BIT

# library(RODBC)
# channel <- RODBC::odbcConnect("CBIBI_2017")

#tab.vec <- c("TAB_EVENT", "TAB_STATIONS", "TAB_PROJECT",
#            "TAB_WQ_DATA", "TAB_PARAMETER_WQ", "TAB_HABITAT_ASSESSMENT",
#           "TAB_HABITAT_PARAMETERS", "TAB_TAXONOMIC_COUNT",
#             "TAB_HUC_12", "TAB_PROGRAM")

# tab.list <- purrr::map(tab.vec, function(tab.i) {
#  RODBC::sqlFetch(channel, tab.i, stringsAsFactors = FALSE) %>% 
#    clean_df()
#}) %>% 
#  set_names(tolower(tab.vec))

#RODBC::odbcCloseAll()

```
Join the hierarchy dataset to the larger dataset using the tsn_final column as the key.
```{r}
tab.list$tab_taxonomic_count <- tab.list$tab_taxonomic_count %>% 
  dplyr::mutate(tsn_final = str_replace_all(tsn_final, "(?<![0-9])0+", "")) %>% 
  left_join(hier.fwmi, by = "tsn_final") %>% 
  prep_taxa()
```

```{r cache=TRUE}
prep.df <- prep_data(tab.list$tab_taxonomic_count,
                     tab.list$tab_wq_data,
                     tab.list$tab_habitat_assessment,
                     tab.list$tab_event,
                     tab.list$tab_stations,
                     tab.list$tab_project,
                     tab.list$tab_huc_12,
                     agg_sample_num = TRUE,
                     development = TRUE)

rm(tab.list)
```

```{r cache=TRUE}
site.class.df <- site_classification(prep.df)
```


```{r cache=TRUE}
taxa.df <- site.class.df %>% 
  ungroup() %>% 
  select(unique_id, category, icprb_bioregion_id, reporting_value,
         final_id, 
         phylum, subphylum, class, subclass,
         order, suborder, family, subfamily, tribe, genus) %>% 
  group_by_at(vars(-reporting_value)) %>% 
  summarize(reporting_value = sum(reporting_value)) %>% 
  ungroup() %>% 
  fill_taxa(final_id, phylum:genus) %>% 
  mutate(final_id = genus) %>% 
  group_by_at(vars(-reporting_value)) %>% 
  summarize(reporting_value = sum(reporting_value)) %>% 
  ungroup()


```

```{r cache=TRUE}
taxa.df <- prob_rarefaction(taxa.df, unique_id, reporting_value, genus, 100)
```

```{r cache=TRUE}
taxa.dev <- taxa.df %>% 
  filter(category %in% c("ref", "deg"))

metrics.df <- taxa.dev %>% 
  select(unique_id, category, icprb_bioregion_id) %>% 
  distinct()

metrics.df <- taxa_seq_parallel(taxa.dev, unique_id, reporting_value,
                                "order", "genus",
                                job = "pct") %>% 
  bind_cols(metrics.df)
```

```{r}

data.table::fwrite(metrics.df, "temp_metrics.csv")
```

